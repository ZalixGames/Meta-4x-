<!DOCTYPE html>
<html lang="en"> <!-- Default theme is now light -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome - Meta 4X Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Tailwind CSS dark mode configuration
        tailwind.config = {
            darkMode: 'class', // Enable class-based dark mode
        }
    </script>
    <style>
        /* Scrollbar styles for dark mode */
        .dark ::-webkit-scrollbar { width: 8px; }
        .dark ::-webkit-scrollbar-track { background: #0d121c; }
        .dark ::-webkit-scrollbar-thumb { background-color: #374151; border-radius: 10px; border: 2px solid #0d121c; }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-overlay { transition: opacity 0.3s ease-in-out; }

        /* Active nav link styles for both light and dark modes */
        .nav-link.active-nav, .sidebar-link.active-nav { color: #14b8a6; /* teal-500 */ background-color: rgba(13, 148, 136, 0.1); }
        .dark .nav-link.active-nav, .dark .sidebar-link.active-nav { color: #2dd4bf; /* teal-400 */ background-color: rgba(45, 212, 191, 0.1); }

        .form-input, .form-select, .form-textarea { 
            background-color: #e5e7eb; border: 2px solid transparent; border-radius: 0.5rem; 
            padding: 0.75rem 1rem; color: #111827; width: 100%; transition: all 0.2s ease-in-out; 
        }
        .dark .form-input, .dark .form-select, .dark .form-textarea { 
            background-color: #2c364d; color: white; 
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { 
            outline: none; border-color: #14b8a6; box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.2); 
        }
        .dark .form-input:focus, .dark .form-select:focus, .dark .form-textarea:focus { 
             border-color: #2dd4bf; box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2); 
        }
        
        .modal-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { position: relative; width: 90%; max-width: 450px; }
        
        .no-data-placeholder { text-align: center; padding: 4rem 1rem; border-radius: 1rem; border: 1px dashed #d1d5db; }
        .dark .no-data-placeholder { background-color: #1a2233; border: 1px dashed #2c364d; }
        .no-data-placeholder svg { width: 100px; height: 100px; margin: 0 auto 1.5rem; color: #d1d5db; }
        .dark .no-data-placeholder svg { color: #2c364d; }
        .no-data-placeholder h3 { font-size: 1.25rem; font-weight: bold; }
        .no-data-placeholder p { color: #6b7280; }
        .dark .no-data-placeholder p { color: #9ca3af; }

        .filter-btn { background-color: #e5e7eb; color: #6b7280; padding: 6px 12px; border-radius: 8px; font-size: 0.875rem; transition: all 0.2s; cursor: pointer; }
        .dark .filter-btn { background-color: #2c364d; color: #9ca3af; }
        .filter-btn.active { background-color: #14b8a6; color: #ffffff; font-weight: bold; }
        .dark .filter-btn.active { background-color: #2dd4bf; }
        .buy-plan-btn { cursor: pointer; }
        
        .promo-banner {
            position: absolute; top: 10px; right: -35px; background: #ef4444; color: white;
            padding: 4px 40px; font-weight: bold; font-size: 1rem; transform: rotate(45deg);
            transform-origin: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .plan-card { overflow: hidden; }

        /* --- Marquee Animation for Partners --- */
        .marquee-container {
            overflow: hidden; position: relative; width: 100%;
            -webkit-mask-image: linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,1) 10%, rgba(0,0,0,1) 90%, rgba(0,0,0,0));
            mask-image: linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,1) 10%, rgba(0,0,0,1) 90%, rgba(0,0,0,0));
        }
        .marquee-content { display: flex; width: max-content; animation: marquee 40s linear infinite; }
        .marquee-content:hover { animation-play-state: paused; }
        .marquee-item { flex-shrink: 0; padding: 0 2.5rem; display: flex; align-items: center; justify-content: center; }
        .dark .marquee-item img { filter: grayscale(1) brightness(1.5); }
        @keyframes marquee {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-50%); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white">

    <!-- Landing Page Section -->
    <div id="landing-page">
        <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm sticky top-0 z-30 shadow-md">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <h1 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500">Meta 4X Trading</h1>
                <div class="flex items-center">
                    <button id="login-btn-landing" class="bg-teal-500 text-white font-bold text-sm py-2 px-5 rounded-lg hover:bg-teal-600">Login</button>
                    <button id="signup-btn-landing" class="ml-2 bg-blue-600 text-white font-bold text-sm py-2 px-5 rounded-lg hover:bg-blue-700">Sign Up</button>
                    <button id="theme-toggle-landing" class="ml-4 text-gray-600 dark:text-white text-2xl"><i class="ri-moon-line"></i></button>
                </div>
            </div>
        </header>
        <main class="container mx-auto px-4 md:px-6 py-12">
            <section class="text-center py-16">
                <h2 class="text-5xl font-extrabold mb-4">Invest in Your Future with <span class="text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500">Meta 4X Trading</span></h2>
                <p class="text-lg text-gray-600 dark:text-gray-400 max-w-3xl mx-auto mb-8">Discover our powerful investment plans and start building your wealth today with cutting-edge technology and expert support.</p>
                <button id="get-started-btn" class="bg-teal-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-teal-600 transition-colors duration-300 text-lg">Get Started Now</button>
            </section>
            <section class="py-12">
                <h3 class="text-3xl font-bold text-center mb-10">Our Investment Plans</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-7xl mx-auto" id="plans-preview-landing"></div>
            </section>
            <section class="py-12">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center max-w-6xl mx-auto">
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg"><i class="ri-rocket-line text-4xl text-teal-500 dark:text-teal-400 mb-3"></i><h4 class="text-2xl font-bold mb-2">100% Fast Service</h4><p class="text-gray-600 dark:text-gray-400">Experience seamless and rapid transactions.</p></div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg"><i class="ri-shield-check-line text-4xl text-teal-500 dark:text-teal-400 mb-3"></i><h4 class="text-2xl font-bold mb-2">100% Trusted</h4><p class="text-gray-600 dark:text-gray-400">Your security and trust are our top priority.</p></div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg"><i class="ri-customer-service-2-line text-4xl text-teal-500 dark:text-teal-400 mb-3"></i><h4 class="text-2xl font-bold mb-2">24/7 Customer Support</h4><p class="text-gray-600 dark:text-gray-400">Our dedicated support team is available to assist you.</p></div>
                </div>
            </section>
            <section id="partners-section" class="py-12">
                <h3 class="text-3xl font-bold text-center mb-10">Our Partners</h3>
                <div id="partners-container" class="max-w-6xl mx-auto">
                    <!-- Partner logos will be injected here by JavaScript -->
                </div>
            </section>
        </main>
        
        <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 mt-16">
            <div class="container mx-auto px-4 md:px-6 py-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
                    <div>
                        <h3 class="text-lg font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500 mb-3">Meta 4X Trading</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Invest in your future with cutting-edge technology and expert support.</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 dark:text-white mb-3">Quick Links</h4>
                        <ul class="space-y-2 text-sm">
                            <li><a href="#" class="text-gray-600 dark:text-gray-400 hover:text-teal-500 dark:hover:text-teal-400">Home</a></li>
                            <li><a href="#plans-preview-landing" class="text-gray-600 dark:text-gray-400 hover:text-teal-500 dark:hover:text-teal-400 scroll-to">Investment Plans</a></li>
                            <li><a href="#" id="footer-login-btn" class="text-gray-600 dark:text-gray-400 hover:text-teal-500 dark:hover:text-teal-400">Login</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 dark:text-white mb-3">Contact Us</h4>
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Support Email: <a href="mailto:support.meta4x@email-temp.com" class="hover:text-teal-500 dark:hover:text-teal-400">support.meta4x@email-temp.com</a></p>
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Address: Level 25, Tower 2, Boulevard Plaza, Downtown Dubai, UAE</p>
                    </div>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-700 mt-8 pt-6 text-center text-gray-500 dark:text-gray-500 text-sm">
                    <p>&copy; <span id="copyright-year"></span> Meta 4X Trading. All Rights Reserved.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Main Application (Dashboard) - Initially hidden -->
    <div id="app-dashboard" class="hidden">
        <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full w-72 bg-white dark:bg-gray-800 text-gray-900 dark:text-white z-50 p-6 shadow-lg -translate-x-full md:translate-x-0 border-r border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-8"><h1 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500">Meta 4X Trading</h1><button id="close-sidebar" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white text-2xl md:hidden"><i class="ri-close-line"></i></button></div>
            <nav class="flex flex-col space-y-2">
                <a href="#dashboard" class="sidebar-link flex items-center justify-between py-3 px-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white rounded-md" data-target="dashboard"><div class="flex items-center"><i class="ri-home-5-line mr-4"></i>Home</div><i class="ri-arrow-right-s-line"></i></a>
                <a href="#plans" class="sidebar-link flex items-center justify-between py-3 px-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white rounded-md" data-target="plans"><div class="flex items-center"><i class="ri-line-chart-line mr-4"></i>My Plans</div><i class="ri-arrow-right-s-line"></i></a>
                <a href="#account-statement" class="sidebar-link flex items-center justify-between py-3 px-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white rounded-md" data-target="account-statement"><div class="flex items-center"><i class="ri-file-list-3-line mr-4"></i>Account Statement</div><i class="ri-arrow-right-s-line"></i></a>
                <a href="#recharge-record" class="sidebar-link flex items-center justify-between py-3 px-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white rounded-md" data-target="recharge-record"><div class="flex items-center"><i class="ri-history-line mr-4"></i>Recharge Record</div><i class="ri-arrow-right-s-line"></i></a>
                <a href="#withdraw-record" class="sidebar-link flex items-center justify-between py-3 px-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white rounded-md" data-target="withdraw-record"><div class="flex items-center"><i class="ri-time-line mr-4"></i>Withdraw Record</div><i class="ri-arrow-right-s-line"></i></a>
                <a href="#change-password" class="sidebar-link flex items-center justify-between py-3 px-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white rounded-md" data-target="change-password"><div class="flex items-center"><i class="ri-lock-password-line mr-4"></i>Change Password</div><i class="ri-arrow-right-s-line"></i></a>
                <a href="#" id="logout-btn-sidebar" class="sidebar-link flex items-center justify-between py-3 px-4 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-white rounded-md" data-target="logout"><div class="flex items-center"><i class="ri-logout-box-r-line mr-4"></i>Logout</div></a>
            </nav>
        </aside>
        <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black bg-opacity-60 z-40 opacity-0 pointer-events-none md:hidden"></div>
        <div class="flex-1 md:ml-72">
            <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm sticky top-0 z-30 shadow-md">
                <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                    <button id="open-sidebar" class="text-gray-800 dark:text-white text-2xl md:hidden"><i class="ri-menu-line"></i></button>
                    <h2 id="page-title" class="text-lg font-bold text-gray-900 dark:text-white"></h2>
                    <button id="theme-toggle-dashboard" class="text-gray-600 dark:text-white text-2xl"><i class="ri-moon-line"></i></button>
                </div>
            </header>
            <main class="flex-1 flex flex-col overflow-hidden"><div id="main-content-container" class="flex-1 p-4 md:p-6 overflow-y-auto pb-24"></div></main>
        </div>
        <nav class="md:hidden fixed bottom-0 inset-x-0 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm shadow-t-lg z-20 border-t border-gray-200 dark:border-gray-700/50">
            <div class="flex justify-around">
                <a href="#dashboard" class="nav-link w-full text-center py-2 text-gray-500 dark:text-gray-400" data-target="dashboard"><i class="ri-home-line text-2xl"></i><span class="block text-xs">Home</span></a>
                <a href="#plans" class="nav-link w-full text-center py-2 text-gray-500 dark:text-gray-400" data-target="plans"><i class="ri-line-chart-line text-2xl"></i><span class="block text-xs">My Plans</span></a>
                <a href="#wallet" class="nav-link w-full text-center py-2 text-gray-500 dark:text-gray-400" data-target="wallet"><i class="ri-wallet-3-line text-2xl"></i><span class="block text-xs">Wallet</span></a>
                <a href="#team" class="nav-link w-full text-center py-2 text-gray-500 dark:text-gray-400" data-target="team"><i class="ri-team-line text-2xl"></i><span class="block text-xs">Team</span></a>
                <a href="#profile" class="nav-link w-full text-center py-2 text-gray-500 dark:text-gray-400" data-target="profile"><i class="ri-user-line text-2xl"></i><span class="block text-xs">Profile</span></a>
            </div>
        </nav>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="modal-overlay"><div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg"><button id="close-login-modal" class="absolute top-4 right-4 text-2xl text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">&times;</button><h2 class="text-2xl font-bold mb-6 text-center">Login</h2><form id="login-form" class="space-y-4"><input type="email" id="login-email" placeholder="Email" class="form-input" required><input type="password" id="login-password" placeholder="Password" class="form-input" required><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Login</button></form><p class="text-center mt-4"><a href="#" id="forgot-password-link" class="text-sm text-teal-500 dark:text-teal-400 hover:underline">Forgot Password?</a></p><p id="login-status" class="text-sm mt-2 text-center"></p></div></div>
    <div id="signup-modal" class="modal-overlay"><div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg"><button id="close-signup-modal" class="absolute top-4 right-4 text-2xl text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">&times;</button><h2 class="text-2xl font-bold mb-6 text-center">Create Account</h2><form id="signup-form" class="space-y-4"><input type="text" id="signup-username" placeholder="Username" class="form-input" required><input type="email" id="signup-email" placeholder="Email" class="form-input" required><input type="password" id="signup-password" placeholder="Password" class="form-input" required><input type="password" id="signup-confirm-password" placeholder="Confirm Password" class="form-input" required><input type="text" id="signup-referral" placeholder="Referral Code (Optional)" class="form-input"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Sign Up</button></form><p id="signup-status" class="text-sm mt-4 text-center"></p></div></div>
    <div id="profile-edit-modal" class="modal-overlay"><div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg"><button id="close-profile-modal" class="absolute top-4 right-4 text-2xl text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">&times;</button><h2 class="text-2xl font-bold mb-6 text-center">Edit Profile</h2><form id="profile-update-form" class="space-y-4"><div><label class="block text-sm text-gray-600 dark:text-gray-400">Full Name</label><input type="text" id="profile-name" class="form-input"></div><div><label class="block text-sm text-gray-600 dark:text-gray-400">Address</label><input type="text" id="profile-address" class="form-input"></div><div><label class="block text-sm text-gray-600 dark:text-gray-400">Age</label><input type="number" id="profile-age" class="form-input"></div><div><label class="block text-sm text-gray-600 dark:text-gray-400">Date of Birth</label><input type="date" id="profile-dob" class="form-input"></div><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Update Profile</button></form></div></div>
    <div id="forgot-password-modal" class="modal-overlay"><div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg"><button id="close-forgot-modal" class="absolute top-4 right-4 text-2xl text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">&times;</button><h2 class="text-2xl font-bold mb-6 text-center">Reset Password</h2><form id="forgot-form" class="space-y-4"><p class="text-sm text-gray-600 dark:text-gray-400 text-center">Enter your email and we will send you a reset link.</p><input type="email" id="forgot-email" placeholder="Email" class="form-input" required><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">Send Reset Link</button></form><p id="forgot-status" class="text-green-500 text-sm mt-4 text-center"></p></div></div>
    <div id="alert-modal" class="modal-overlay" style="justify-content: center; align-items: center;"><div class="modal-content text-center bg-white dark:bg-gray-800 p-8 rounded-lg"><h3 id="alert-title" class="text-xl font-bold mb-4"></h3><p id="alert-message" class="text-gray-700 dark:text-gray-300 mb-6"></p><button id="alert-close-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">OK</button></div></div>
    
    <svg id="no-data-svg" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.888 4.933l1.556-1.556L18.067 17l-1.556 1.556zM21 3.784L19.216 2 13 8.216l1.784 1.784L21 3.784zM12.91 18.082l-1.41-1.41-1.41 1.41-1.41-1.41-1.41 1.41-1.41-1.41-1.41 1.41L3 16.672V21h4.328l1.41-1.41-1.41-1.41 1.41-1.41 1.41 1.41 1.41-1.41 1.41 1.41 1.41-1.41L18.067 17 15 13.933l-2.09 2.09-.001 2.059zm-3.82-10L12 5.172 14.828 8 12 10.828 9.09 7.918zM4.067 3l-1.556.002L1 4.557V10h1v-.557l1.555-1.556L5.11 9.443l.002-1.555L4.067 3z"></path></svg>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB6Ce3tA6iIOsEejca7U7kqHb6GMoaf8C8",
            authDomain: "mata4x-caa39.firebaseapp.com",
            databaseURL: "https://mata4x-caa39-default-rtdb.firebaseio.com",
            projectId: "mata4x-caa39",
            storageBucket: "mata4x-caa39.firebasestorage.app",
            messagingSenderId: "671191529609",
            appId: "1:671191529609:web:d56ab7de30117ded95ee58",
            measurementId: "G-C3XZKPZZWN"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        let appSettings = {};
        let currentUserData = null;
        let earningsChart = null;
        let userRefListener = null;
        let claimUpdateInterval = null;

        // --- CORE APP INITIALIZATION ---
        async function initializeApp() {
            try {
                const settingsSnapshot = await database.ref('settings').once('value');
                appSettings = settingsSnapshot.val() || { plans: {}, previewPlans: {}, sliderImages: [], profileLinks: {}, referralCommission: {}, partners: {} };
            } catch (error) {
                console.error("Could not fetch app settings:", error);
                appSettings = { plans: {}, previewPlans: {}, sliderImages: [], profileLinks: {}, referralCommission: {}, partners: {} };
            }

            // [LOGIN FIX] This is the central controller for authentication state.
            auth.onAuthStateChanged(user => {
                // 1. Always clean up previous listeners to prevent memory leaks and ghost data.
                if (userRefListener) {
                    const oldUid = userRefListener.ref.toString().split('/').pop();
                    database.ref('users/' + oldUid).off('value', userRefListener);
                    userRefListener = null; // Set to null to confirm it's detached.
                }
                if (claimUpdateInterval) {
                    clearInterval(claimUpdateInterval);
                    claimUpdateInterval = null;
                }

                // 2. Check the new user state.
                if (user && user.emailVerified) {
                    // User is logged in and verified.
                    const userRef = database.ref('users/' + user.uid);
                    let isInitialLoad = true; 

                    // Set up the persistent listener for real-time data updates.
                    userRefListener = userRef.on('value', (snapshot) => {
                        currentUserData = snapshot.val();

                        if (!currentUserData) {
                            console.error("User authenticated, but no data record found in the database. Forcing logout.");
                            handleLogout();
                            return;
                        }

                        // This flag ensures showDashboard() is only called once when the listener first gets data.
                        // This handles both initial page loads (if already logged in) and manual logins correctly.
                        if (isInitialLoad) {
                            showDashboard();
                            isInitialLoad = false;
                        } else {
                            // For subsequent real-time updates (e.g., wallet change), just refresh the content of the current page.
                            const currentHash = window.location.hash.substring(1) || 'dashboard';
                            if (document.getElementById('app-dashboard').style.display === 'block') {
                               loadPage(currentHash);
                            }
                        }
                    }, (error) => {
                        console.error("Firebase permission denied or other error:", error);
                        handleLogout();
                    });
                } else {
                    // User is logged out, unverified, or doesn't exist.
                    currentUserData = null;
                    showLandingPage();
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupStaticListeners();
            setupThemeToggle();
        });

        // --- THEME TOGGLE ---
        function setupThemeToggle() {
            const themeToggleLanding = document.getElementById('theme-toggle-landing');
            const themeToggleDashboard = document.getElementById('theme-toggle-dashboard');
            const htmlEl = document.documentElement;
            const sunIcon = 'ri-sun-line';
            const moonIcon = 'ri-moon-line';

            function updateIcons(isDark) {
                const iconClass = isDark ? sunIcon : moonIcon;
                if (themeToggleLanding) themeToggleLanding.innerHTML = `<i class="${iconClass}"></i>`;
                if (themeToggleDashboard) themeToggleDashboard.innerHTML = `<i class="${iconClass}"></i>`;
            }

            function toggleTheme() {
                htmlEl.classList.toggle('dark');
                const isDarkMode = htmlEl.classList.contains('dark');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                updateIcons(isDarkMode);
            }

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                htmlEl.classList.add('dark');
                updateIcons(true);
            } else {
                htmlEl.classList.remove('dark');
                updateIcons(false);
            }

            if (themeToggleLanding) themeToggleLanding.addEventListener('click', toggleTheme);
            if (themeToggleDashboard) themeToggleDashboard.addEventListener('click', toggleTheme);
        }

        // --- AUTH & PAGE VISIBILITY ---
        function showDashboard() {
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('app-dashboard').style.display = 'block';
            if (!document.body.classList.contains('dashboard-listeners-set')) {
                setupDashboardListeners();
                document.body.classList.add('dashboard-listeners-set');
            }
            handleHashChange();
        }

        function showLandingPage() {
            document.getElementById('landing-page').style.display = 'block';
            document.getElementById('app-dashboard').style.display = 'none';
            document.getElementById('main-content-container').innerHTML = '';
            window.location.hash = '';
            populateLandingPagePlans();
            populatePartnersSection();
        }

        function handleLogout() {
            auth.signOut().catch(error => {
                console.error("Logout failed", error);
                showAlert("Logout Error", "An error occurred during logout: " + error.message);
            });
        }

        function populateLandingPagePlans() {
            const plansContainer = document.getElementById('plans-preview-landing');
            if (!plansContainer) return;
            const plans = appSettings.previewPlans || {};
            if (Object.keys(plans).length > 0) {
                plansContainer.innerHTML = Object.keys(plans).map(key => createPlanCardHTML({ id: key, ...plans[key] }, { isLanding: true, showBuyButton: false })).join('');
            } else {
                plansContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No investment plans are available at the moment.</p>';
            }
        }
        
        function populatePartnersSection() {
            const partnersContainer = document.getElementById('partners-container');
            const partnersSection = document.getElementById('partners-section');
            if (!partnersContainer || !partnersSection) return;
            const partners = appSettings.partners || {};
            
            if (Object.keys(partners).length > 0) {
                partnersSection.style.display = 'block';
                const partnerLogos = Object.values(partners).map(partner => 
                    `<div class="marquee-item"><img src="${partner.logoUrl}" alt="${partner.name}" class="h-12" title="${partner.name}" loading="lazy"></div>`
                ).join('');

                const marqueeContent = partnerLogos + partnerLogos;
                
                partnersContainer.innerHTML = `
                    <div class="marquee-container">
                        <div class="marquee-content">${marqueeContent}</div>
                    </div>
                `;
            } else {
                partnersSection.style.display = 'none';
            }
        }

        function handleHashChange() { 
            const target = window.location.hash.substring(1) || 'dashboard'; 
            loadPage(target); 
            updateActiveLink(target); 
        }

        function loadPage(targetId) {
            if (claimUpdateInterval) {
                clearInterval(claimUpdateInterval);
                claimUpdateInterval = null;
            }

            if (!currentUserData || !auth.currentUser) {
                console.warn("loadPage called without user data. Redirecting to landing.");
                showLandingPage();
                return; 
            }

            const mainContentContainer = document.getElementById('main-content-container');
            const pageTitle = document.getElementById('page-title');
            const pageTitleMap = { 'dashboard': 'Dashboard', 'plans': 'My Plans', 'wallet': 'Wallet', 'team': 'Team', 'profile': 'Profile', 'leaderboard': 'Leaderboard', 'account-statement': 'Account Statement', 'recharge-record': 'Recharge Record', 'withdraw-record': 'Withdraw Record', 'change-password': 'Change Password' };
            pageTitle.textContent = pageTitleMap[targetId] || 'Dashboard';
            mainContentContainer.innerHTML = '';

            const pageRenderers = {
                'dashboard': renderDashboardPage, 'plans': renderPlansPage, 'wallet': setupWallet,
                'team': renderTeamPage, 'profile': renderProfilePage, 'leaderboard': renderLeaderboardPage,
                'account-statement': (userData) => renderHistoryPage(userData, 'account-statement'),
                'recharge-record': (userData) => renderHistoryPage(userData, 'recharge-record'),
                'withdraw-record': (userData) => renderHistoryPage(userData, 'withdraw-record'),
                'change-password': renderChangePasswordPage
            };
            const renderFunction = pageRenderers[targetId];
            if (renderFunction) {
                renderFunction(currentUserData);
            } else {
                renderDashboardPage(currentUserData);
            }
        }
        
        // --- PAGE RENDERERS ---
        function renderDashboardPage(userData) {
            const mainContentContainer = document.getElementById('main-content-container');
            const plans = appSettings.plans || {};
            
            const activePlanIds = Object.values(userData.activePlans || {}).map(p => p.id);

            const plansHTML = Object.keys(plans).length > 0
                ? Object.keys(plans).map(key => {
                    const isPurchased = activePlanIds.includes(key);
                    return createPlanCardHTML({ id: key, ...plans[key] }, { showBuyButton: true, isPurchased: isPurchased });
                }).join('')
                : createNoDataPlaceholder("No Plans Available", "Check back later for investment opportunities.");

            const content = `<div id="image-slider-container" class="relative w-full max-w-4xl mx-auto rounded-lg overflow-hidden shadow-2xl border border-gray-200 dark:border-gray-700 mb-6 cursor-grab active:cursor-grabbing"><div id="slider-inner" class="flex transition-transform duration-700 ease-in-out"></div><div id="slider-dots" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2"></div></div>
                <div class="grid grid-cols-4 gap-4 text-center mb-8 max-w-md mx-auto">
                    <a href="#wallet" data-target="wallet" class="action-icon nav-link"><div class="bg-white dark:bg-gray-800 w-14 h-14 rounded-full flex items-center justify-center mx-auto shadow-md"><i class="ri-wallet-3-line text-2xl"></i></div><span class="text-sm mt-2 block">Deposit</span></a>
                    <a href="#wallet" data-target="wallet" class="action-icon nav-link"><div class="bg-white dark:bg-gray-800 w-14 h-14 rounded-full flex items-center justify-center mx-auto shadow-md"><i class="ri-hand-coin-line text-2xl"></i></div><span class="text-sm mt-2 block">Withdraw</span></a>
                    <a href="#team" data-target="team" class="action-icon nav-link"><div class="bg-white dark:bg-gray-800 w-14 h-14 rounded-full flex items-center justify-center mx-auto shadow-md"><i class="ri-user-add-line text-2xl"></i></div><span class="text-sm mt-2 block">Invite</span></a>
                    <a href="#leaderboard" data-target="leaderboard" class="action-icon nav-link"><div class="bg-white dark:bg-gray-800 w-14 h-14 rounded-full flex items-center justify-center mx-auto shadow-md"><i class="ri-trophy-line text-2xl"></i></div><span class="text-sm mt-2 block">Leaderboard</span></a>
                </div>
                <h2 class="text-2xl font-bold mb-6 text-center">Investment Plans</h2>
                <div class="space-y-6 max-w-2xl mx-auto">${plansHTML}</div>`;
            mainContentContainer.innerHTML = content;
            setupSlider();
        }

        function renderPlansPage(userData) {
            const mainContentContainer = document.getElementById('main-content-container');
            const activePlans = userData.activePlans || {};
            const hasActivePlan = Object.keys(activePlans).length > 0;
            const activePlansHTML = hasActivePlan 
                ? Object.keys(activePlans).map(planKey => createPlanCardHTML({ ...activePlans[planKey], planKey: planKey }, { isActive: true, showBuyButton: false })).join('')
                : createNoDataPlaceholder('No Active Plans', 'You have not purchased any plans yet.');
            
            const totalEarnings = Object.values(userData.transactions?.earnings || {}).reduce((sum, earn) => sum + earn.amount, 0);
            
            mainContentContainer.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-lg mb-8">
                    <h2 class="text-xl font-bold">Earnings Overview</h2>
                    <div><p class="text-gray-600 dark:text-gray-400 text-sm">Total Lifetime Earnings</p><p class="text-3xl font-bold text-gray-900 dark:text-white">$${totalEarnings.toFixed(2)}</p></div>
                    <div class="h-48 mt-4"><canvas id="earningsChart"></canvas></div>
                </div>
                <h2 class="text-xl font-bold my-6">Your Active Plans</h2>
                <div class="space-y-6 max-w-2xl mx-auto">${activePlansHTML}</div>`;
            setupEarningsChart(userData.transactions?.earnings || {});
            
            if(hasActivePlan) {
                updateClaimStatus();
                claimUpdateInterval = setInterval(updateClaimStatus, 60 * 1000); 
            }
        }

        function renderTeamPage(userData) {
            const mainContentContainer = document.getElementById('main-content-container');
            const team = userData.team || {};
            const referralCode = userData.profile?.referralCode || 'N/A';
            const referralLink = `${window.location.origin}${window.location.pathname}?ref=${referralCode}`;

            const levelCard = (level, percentage, data) => `<div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700"><div class="flex justify-between items-center"><h3 class="text-lg font-bold text-gray-900 dark:text-white">Level ${level}</h3><span class="text-xs font-bold bg-teal-100 dark:bg-teal-500/20 text-teal-700 dark:text-teal-400 px-2 py-1 rounded-full">${percentage}%</span></div><div class="mt-4 grid grid-cols-2 gap-4 text-center"><div><p class="text-sm text-gray-600 dark:text-gray-400">Total</p><p class="text-2xl font-bold">${data?.count||0}</p></div><div><p class="text-sm text-gray-600 dark:text-gray-400">Active</p><p class="text-2xl font-bold">${data?.active||0}</p></div></div><div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-3"><p class="text-sm text-gray-600 dark:text-gray-400 text-center">Commission</p><p class="text-xl font-bold text-teal-500 dark:text-teal-400 text-center">$${(data?.commission||0).toFixed(2)}</p></div></div>`;
            const membersList = (members) => members && members.length > 0 ? `<ul class="space-y-2">${members.map(m => `<li class="flex items-center justify-between p-3 bg-gray-100 dark:bg-gray-700/50 rounded-lg"><span>${m.name}</span><span class="text-xs px-2 py-0.5 rounded-full ${m.status==='active'?'bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-300':'bg-yellow-100 dark:bg-yellow-500/20 text-yellow-700 dark:text-yellow-300'}">${m.status}</span></li>`).join('')}</ul>` : createNoDataPlaceholder('No Members', 'No one invited to Level 1 yet.');
            
            mainContentContainer.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">Referral Team</h2>
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 mb-6 space-y-4">
                    <div>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">Your Referral Link</p>
                        <div class="flex items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md">
                            <input id="ref-link-input" type="text" value="${referralLink}" class="bg-transparent w-full" readonly>
                            <button onclick="navigator.clipboard.writeText('${referralLink}')" class="ml-3 bg-teal-500 px-4 py-2 rounded-md text-sm font-bold text-white">Copy Link</button>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">Your Referral Code</p>
                        <div class="flex items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md">
                            <input id="ref-code-input" type="text" value="${referralCode}" class="bg-transparent w-full font-mono" readonly>
                            <button onclick="navigator.clipboard.writeText('${referralCode}')" class="ml-3 bg-blue-600 px-4 py-2 rounded-md text-sm font-bold text-white">Copy Code</button>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 mb-6 text-center">
                    <p class="text-gray-600 dark:text-gray-400">Total Commission</p>
                    <p class="text-4xl font-bold mt-1">$${(team.totalCommission||0).toFixed(2)}</p>
                </div>
                <div class="space-y-6">${levelCard(1,10,team.level1)}${levelCard(2,5,team.level2)}${levelCard(3,2,team.level3)}</div>
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4">Level 1 Members</h3>
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-4">${membersList(team.level1?.members)}</div>
                </div>`;
        }


        function renderProfilePage(userData) {
            const mainContentContainer = document.getElementById('main-content-container');
            const { profile, transactions, team } = userData;
            const totalDeposit = Object.values(transactions?.deposits||{}).filter(d=>d.status==='approved').reduce((s,d)=>s+d.amount,0);
            const totalWithdrawal = Object.values(transactions?.withdrawals||{}).filter(w=>w.status==='approved').reduce((s,w)=>s+w.amount,0);
            const lifetimeEarnings = Object.values(transactions?.earnings||{}).reduce((s,e)=>s+e.amount,0);
            const statCard = (icon, label, value, color) => `<div class="bg-white dark:bg-gray-800 p-4 rounded-xl text-center shadow"><i class="ri-${icon}-line text-3xl text-${color}-500 dark:text-${color}-400 mb-2"></i><p class="text-sm text-gray-600 dark:text-gray-400">${label}</p><p class="text-lg font-bold">$${value.toFixed(2)}</p></div>`;
            const profileLinks = appSettings.profileLinks || {};
            const menuItems = [
                { name: 'Leaderboard', icon: 'trophy', target: '#leaderboard' },
                { name: 'Customer Service', icon: 'customer-service-2', target: profileLinks.support || '#' },
                { name: 'Help Center', icon: 'question', target: profileLinks.help || '#' },
                { name: 'Privacy Policy', icon: 'shield-check', target: profileLinks.privacy || '#' },
                { name: 'Terms & Conditions', icon: 'file-list-3', target: profileLinks.terms || '#' }
            ];
            mainContentContainer.innerHTML = `<h2 class="text-2xl font-bold mb-6">Profile</h2><div class="bg-white dark:bg-gray-800 rounded-lg p-6 mb-6 shadow"><div class="flex items-center space-x-4"><img id="profile-pic" src="${profile.avatar}" alt="Avatar" class="w-24 h-24 rounded-full object-cover" loading="lazy"><div class="flex-1"><h3>${profile.name}</h3><p class="text-gray-600 dark:text-gray-400 text-sm">${profile.email}</p><button id="edit-profile-btn" class="mt-2 bg-gray-200 dark:bg-gray-700 text-sm py-2 px-4 rounded-lg">Edit Profile</button></div></div></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">${statCard('wallet-3','Deposit',totalDeposit,'blue')}${statCard('hand-coin','Withdrawal',totalWithdrawal,'red')}${statCard('line-chart','Earnings',lifetimeEarnings,'green')}${statCard('gift-2','Reward',team?.totalCommission||0,'yellow')}</div><div class="space-y-3">${menuItems.map(item=>`<a href="${item.target}" class="bg-white dark:bg-gray-800 p-4 rounded-lg flex items-center justify-between hover:bg-gray-100 dark:hover:bg-gray-700 nav-link shadow" ${item.target.startsWith('#') ? `data-target="${item.target.substring(1)}"` : 'target="_blank"'}><div class="flex items-center"><i class="ri-${item.icon}-line text-xl text-teal-500 dark:text-teal-400 mr-4"></i><span class="font-bold">${item.name}</span></div><i class="ri-arrow-right-s-line text-gray-500 dark:text-gray-400"></i></a>`).join('')}</div><button id="logout-btn-profile" class="w-full mt-6 bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 flex items-center justify-center"><i class="ri-logout-box-r-line mr-2"></i>Logout</button>`;
            
            document.getElementById('edit-profile-btn').addEventListener('click', () => { 
                document.getElementById('profile-edit-modal').style.display = 'flex'; 
            });
        }
        
        async function renderLeaderboardPage() {
            const mainContentContainer = document.getElementById('main-content-container');
            mainContentContainer.innerHTML = `<h2 class="text-2xl font-bold mb-6">Leaderboard</h2><div id="leaderboard-content"></div>`;
            const contentEl = document.getElementById('leaderboard-content');
            try {
                const snapshot = await database.ref('leaderboard').orderByChild('earnings').once('value');
                if (snapshot.exists()) {
                    const data = [];
                    snapshot.forEach(child => { data.push({ id: child.key, ...child.val() }); });
                    const sortedData = data.sort((a, b) => b.earnings - a.earnings);
                    
                    const rankColors = ['bg-yellow-500', 'bg-gray-400', 'bg-yellow-700'];
                    const rankIcons = ['ri-trophy-fill', 'ri-medal-fill', 'ri-medal-fill'];

                    contentEl.innerHTML = `<ul class="space-y-3">${sortedData.map((user, index) => `
                        <li class="flex items-center bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                            <span class="text-lg font-bold w-10 text-center ${index < 3 ? rankColors[index] : 'text-gray-500'}">
                                ${index < 3 ? `<i class="${rankIcons[index]}"></i>` : `#${index + 1}`}
                            </span>
                            <img src="${user.avatar}" class="w-12 h-12 rounded-full mx-4 object-cover" loading="lazy">
                            <div class="flex-1"><p class="font-bold text-gray-900 dark:text-white">${user.name}</p></div>
                            <div class="text-right">
                                <p class="font-bold text-lg text-teal-500 dark:text-teal-400">$${user.earnings.toFixed(2)}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Total Earnings</p>
                            </div>
                        </li>
                    `).join('')}</ul>`;
                } else {
                    contentEl.innerHTML = createNoDataPlaceholder("Leaderboard is Empty", "Top performers will be displayed here once available.");
                }
            } catch(error) {
                console.error("Error fetching leaderboard:", error);
                contentEl.innerHTML = createNoDataPlaceholder("Error", "Could not load the leaderboard data.");
            }
        }

        function renderChangePasswordPage() {
            const mainContentContainer = document.getElementById('main-content-container');
             mainContentContainer.innerHTML = `<div class="max-w-md mx-auto"><h2 class="text-2xl font-bold mb-6">Change Password</h2><div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow"><form id="change-pass-form" class="space-y-4"><div><label class="block text-sm">Current Password</label><input type="password" id="current-pass" class="form-input" required></div><div><label class="block text-sm">New Password</label><input type="password" id="new-pass" class="form-input" required></div><div><label class="block text-sm">Confirm New Password</label><input type="password" id="confirm-new-pass" class="form-input" required></div><button type="submit" class="w-full bg-blue-600 font-bold py-3 rounded-lg text-white">Update Password</button></form><p id="change-pass-status" class="text-sm mt-4 text-center"></p></div></div>`;
        }
        
        function setupWallet(userData) {
            const mainContentContainer = document.getElementById('main-content-container');
            const wallet = userData.wallet || { deposited: 0, withdrawable: 0 };
            const total = (wallet.deposited || 0) + (wallet.withdrawable || 0);
            const transactions = userData.transactions || {};
            const allRecords = [
                ...Object.values(transactions.deposits || {}).map(o => ({...o, type: 'Deposit'})), 
                ...Object.values(transactions.withdrawals || {}).map(o => ({...o, type: 'Withdrawal'})),
                ...Object.values(transactions.earnings || {}).map(o => ({...o, type: 'Earning'})), 
                ...Object.values(transactions.other || {}).map(o => ({...o, type: o.type || 'Other'}))
            ];
            const historyHTML = (() => {
                if (allRecords.length === 0) return createNoDataPlaceholder('No Recent Transactions', 'Your recent transaction history will appear here.');
                allRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                return `<div class="mt-8"><h3 class="text-xl font-bold mb-4">Recent Transactions</h3><div style="max-height: 40vh; overflow-y: auto;"><ul class="space-y-2 pr-2">${allRecords.map(rec => {
                    const isWithdrawal = rec.type === 'Withdrawal';
                    const sign = isWithdrawal ? '-' : '+';
                    const icon = isWithdrawal ? 'ri-arrow-up-circle-line' : (rec.type === 'Earning' ? 'ri-star-fill' : 'ri-arrow-down-circle-line');
                    const iconColor = isWithdrawal ? 'text-red-500 dark:text-red-400' : (rec.type === 'Earning' ? 'text-yellow-500 dark:text-yellow-400' : 'text-green-500 dark:text-green-400');
                    return `<li class="flex items-center justify-between p-3 bg-gray-100 dark:bg-gray-700/50 rounded-lg"><div class="flex items-center"><i class="${icon} text-2xl ${iconColor} mr-3"></i><div><p class="font-semibold text-gray-900 dark:text-white">${rec.type}</p><p class="text-xs text-gray-500 dark:text-gray-400">${new Date(rec.timestamp).toLocaleDateString()}</p></div></div><span class="font-bold ${iconColor}">${sign}$${rec.amount.toFixed(2)}</span></li>`;
                }).join('')}</ul></div></div>`;
            })();

            const templates = {
                main: `<div><div class="bg-white dark:bg-gray-800 rounded-xl p-5 mb-6 text-center shadow"><p class="text-sm text-gray-600 dark:text-gray-400">Total Balance</p><p class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500 mt-1">$${total.toFixed(2)}</p></div><div class="grid grid-cols-2 gap-4"><div class="bg-white dark:bg-gray-800 p-4 rounded-lg text-center shadow"><p>Deposited</p><p class="text-2xl font-bold">$${(wallet.deposited || 0).toFixed(2)}</p></div><div class="bg-white dark:bg-gray-800 p-4 rounded-lg text-center shadow"><p>Withdrawable</p><p class="text-2xl font-bold text-teal-500 dark:text-teal-400">$${(wallet.withdrawable || 0).toFixed(2)}</p></div></div><div class="grid grid-cols-2 gap-4 mt-6"><button id="show-deposit" class="w-full bg-green-500 hover:bg-green-600 font-bold py-3 rounded-lg text-white flex items-center justify-center"><i class="ri-add-circle-line mr-2"></i>Deposit</button><button id="show-withdraw" class="w-full bg-red-500 hover:bg-red-600 font-bold py-3 rounded-lg text-white flex items-center justify-center"><i class="ri-indeterminate-circle-line mr-2"></i>Withdraw</button></div>${historyHTML}</div>`,
                deposit: `<div><button class="back-to-wallet text-teal-500 dark:text-teal-400 mb-4 flex items-center hover:underline"><i class="ri-arrow-left-s-line mr-1"></i>Back to Wallet</button><div class="max-w-md mx-auto"><h2 class="text-2xl font-bold mb-4 text-center">Deposit USDT</h2><div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow"><p class="text-sm text-gray-600 dark:text-gray-400 mb-2 text-center">Send funds to the following address (TRC20):</p><div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-md text-center mb-6"><p class="text-teal-500 dark:text-teal-400 font-mono break-all">TXYZ123abcDEF456ghiJKL789mnoPQR</p></div><form id="deposit-form" class="space-y-4"><div><label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Amount Sent (USDT)</label><input type="number" id="deposit-amount" step="0.01" class="form-input" required></div><div><label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Transaction ID (TxID)</label><input type="text" id="deposit-txid" class="form-input" required></div><div><label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Transaction Screenshot</label><input type="file" id="deposit-screenshot" class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 dark:file:bg-teal-500/10 file:text-teal-700 dark:file:text-teal-300 hover:file:bg-teal-100 dark:hover:file:bg-teal-500/20" accept="image/*" required></div><button type="submit" class="w-full bg-blue-600 font-bold py-3 rounded-lg hover:bg-blue-700 text-white mt-2">Submit Deposit</button></form><p id="deposit-status" class="text-sm mt-4 text-center"></p></div></div></div>`,
                withdraw: `<div><button class="back-to-wallet text-teal-500 dark:text-teal-400 mb-4 flex items-center hover:underline"><i class="ri-arrow-left-s-line mr-1"></i>Back to Wallet</button><div class="max-w-md mx-auto"><h2 class="text-2xl font-bold mb-4 text-center">Withdraw USDT</h2><div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow"><form id="withdraw-form" class="space-y-4"><div><label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Your Wallet Address (TRC20)</label><input type="text" id="withdraw-address" placeholder="Enter your TRC20 address" class="form-input" required></div><div><label class="block text-sm text-gray-600 dark:text-gray-400 mb-1">Amount to Withdraw</label><input type="number" id="withdraw-amount" step="0.01" placeholder="Min $10.00" class="form-input" required></div><button type="submit" class="w-full bg-blue-600 font-bold py-3 rounded-lg hover:bg-blue-700 text-white mt-2">Submit Withdrawal</button></form><p id="withdraw-status" class="text-sm mt-4 text-center"></p></div></div></div>`
            };
            
            const showView = v => {
                mainContentContainer.innerHTML = templates[v];
                if (v !== 'main') {
                    mainContentContainer.querySelector('.back-to-wallet').addEventListener('click', () => showView('main'));
                } else {
                    document.getElementById('show-deposit').addEventListener('click', () => showView('deposit'));
                    document.getElementById('show-withdraw').addEventListener('click', () => showView('withdraw'));
                }
                if (v === 'deposit') {
                    document.getElementById('deposit-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const statusEl = document.getElementById('deposit-status');
                        const submitBtn = e.target.querySelector('button[type="submit"]');
                        const imageFile = document.getElementById('deposit-screenshot').files[0];

                        if (!imageFile) {
                            statusEl.textContent = 'Please upload a screenshot.'; statusEl.className = 'text-red-500 text-sm mt-4 text-center';
                            return;
                        }

                        submitBtn.disabled = true;
                        statusEl.textContent = 'Uploading...'; statusEl.className = 'text-yellow-400 text-sm mt-4 text-center';

                        const apiKey = '1b4c33d73040d3333641c039b20b10e5';
                        const formData = new FormData();
                        formData.append('image', imageFile);

                        try {
                            const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                                method: 'POST',
                                body: formData,
                            });
                            const result = await response.json();

                            if (!result.success) {
                                throw new Error(result.error.message || 'Image upload failed.');
                            }
                            
                            const imageUrl = result.data.url;
                            statusEl.textContent = 'Upload successful. Submitting request...';
                            statusEl.className = 'text-green-500 text-sm mt-4 text-center';

                            const currentUser = auth.currentUser;
                            if (!currentUser) { statusEl.textContent = 'Error: Not logged in.'; statusEl.className = 'text-red-500'; submitBtn.disabled = false; return; }
                            
                            const depositData = {
                                userId: currentUser.uid, userEmail: currentUser.email,
                                amount: parseFloat(document.getElementById('deposit-amount').value),
                                txId: document.getElementById('deposit-txid').value,
                                screenshotUrl: imageUrl,
                                status: 'pending', timestamp: new Date().toISOString()
                            };
                            
                            const requestRef = database.ref('requests/deposits').push();
                            const updates = {};
                            updates[`/requests/deposits/${requestRef.key}`] = depositData;
                            updates[`/users/${currentUser.uid}/transactions/deposits/${requestRef.key}`] = depositData;
                            
                            await database.ref().update(updates);
                            statusEl.textContent = 'Your deposit request has been submitted for approval.';
                            statusEl.className = 'text-green-500 text-sm mt-4 text-center';
                            e.target.reset();

                        } catch (error) {
                            statusEl.textContent = 'Submission failed: ' + error.message;
                            statusEl.className = 'text-red-500 text-sm mt-4 text-center';
                        } finally {
                            submitBtn.disabled = false;
                        }
                    });
                }
                if (v === 'withdraw') {
                     document.getElementById('withdraw-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const statusEl = document.getElementById('withdraw-status');
                        statusEl.textContent = 'Processing...'; statusEl.className = 'text-yellow-400 text-sm mt-4 text-center';
                        const currentUser = auth.currentUser;
                        if (!currentUser) { statusEl.textContent = 'Error: Not logged in.'; statusEl.className = 'text-red-500'; return; }
                        const amount = parseFloat(document.getElementById('withdraw-amount').value);

                        if (currentUserData.wallet.withdrawable < amount) {
                            statusEl.textContent = 'Insufficient withdrawable balance.';
                            statusEl.className = 'text-red-500 text-sm mt-4 text-center';
                            return;
                        }

                        const withdrawData = {
                            userId: currentUser.uid, userEmail: currentUser.email,
                            amount: amount, walletAddress: document.getElementById('withdraw-address').value,
                            status: 'pending', timestamp: new Date().toISOString()
                        };
                        try {
                            const requestRef = database.ref('requests/withdrawals').push();
                            const updates = {};
                            updates[`/requests/withdrawals/${requestRef.key}`] = withdrawData;
                            updates[`/users/${currentUser.uid}/transactions/withdrawals/${requestRef.key}`] = withdrawData;
                            
                            await database.ref().update(updates);
                            statusEl.textContent = 'Your withdrawal request is pending.';
                            statusEl.className = 'text-green-500 text-sm mt-4 text-center';
                            e.target.reset();
                        } catch (error) {
                             statusEl.textContent = 'Submission failed: ' + error.message;
                             statusEl.className = 'text-red-500 text-sm mt-4 text-center';
                        }
                    });
                }
            };
            showView('main');
        }

        function renderHistoryPage(userData, targetId) {
            const mainContentContainer = document.getElementById('main-content-container');
            const transactions = userData.transactions || {};
            
            const allRecords = [
                ...Object.values(transactions.deposits || {}).map(o => ({...o, type: 'Deposit'})), 
                ...Object.values(transactions.withdrawals || {}).map(o => ({...o, type: 'Withdrawal'})),
                ...Object.values(transactions.earnings || {}).map(o => ({...o, type: 'Earning'})), 
                ...Object.values(transactions.other || {}).map(o => ({...o, type: o.type || 'Other'}))
            ];

            const config = {
                'account-statement': { title: 'Account Statement', records: allRecords },
                'recharge-record': { title: 'Recharge Record', records: Object.values(transactions.deposits || {}).map(o => ({...o, type: 'Deposit'})) },
                'withdraw-record': { title: 'Withdrawal Record', records: Object.values(transactions.withdrawals || {}).map(o => ({...o, type: 'Withdrawal'})) }
            };

            const pageConfig = config[targetId];
            if (!pageConfig) {
                mainContentContainer.innerHTML = createNoDataPlaceholder('Error', 'Page configuration not found.');
                return;
            }

            const { title, records } = pageConfig;

            if (records && records.length > 0) {
                records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                mainContentContainer.innerHTML = `<h2 class="text-2xl font-bold mb-6">${title}</h2><div class="bg-white dark:bg-gray-800 rounded-lg overflow-x-auto shadow"><table class="w-full text-left text-sm">
                    <thead class="bg-gray-100 dark:bg-gray-700 uppercase"><tr><th class="p-3">Date</th><th class="p-3">Amount</th><th class="p-3">Type</th><th class="p-3">Details</th><th class="p-3">Status</th></tr></thead>
                    <tbody>${records.map(rec => {
                        const isWithdrawal = rec.type === 'Withdrawal' || rec.type === 'Plan Purchase';
                        const amountColor = isWithdrawal ? 'text-red-500 dark:text-red-400' : 'text-green-500 dark:text-green-400';
                        const sign = isWithdrawal ? '-' : '+';
                        const statusClass = rec.status === 'approved' ? 'bg-green-500/20 text-green-700 dark:text-green-300' : (rec.status === 'pending' ? 'bg-yellow-500/20 text-yellow-700 dark:text-yellow-300' : 'bg-red-500/20 text-red-700 dark:text-red-300');
                        const details = rec.details || rec.txId || rec.planName || 'N/A';
                        return `<tr class="border-b border-gray-200 dark:border-gray-700"><td class="p-3">${new Date(rec.timestamp).toLocaleString()}</td>
                                    <td class="p-3 font-mono ${amountColor}">${sign} $${rec.amount.toFixed(2)}</td>
                                    <td class="p-3">${rec.type}</td>
                                    <td class="p-3 text-gray-500 dark:text-gray-400 text-xs">${details}</td>
                                    <td class="p-3"><span class="px-2 py-1 text-xs rounded-full ${statusClass}">${rec.status}</span></td></tr>`;
                    }).join('')}</tbody></table></div>`;
            } else {
                mainContentContainer.innerHTML = createNoDataPlaceholder('No Records Found', `Your ${title.toLowerCase()} is empty.`);
            }
        }
        
        // --- HELPER & UTILITY FUNCTIONS ---
        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 7; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function createNoDataPlaceholder(title, message) {
            const noDataSVG = document.getElementById('no-data-svg').innerHTML;
            return `<div class="no-data-placeholder">${noDataSVG}<h3>${title}</h3><p>${message}</p></div>`;
        }

        function createPlanCardHTML(plan, options = {}) {
            const { isActive = false, showBuyButton = true, isLanding = false, isPurchased = false } = options;
            const containerClass = `plan-card relative ${isLanding ? 'flex flex-col p-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg' : 'flex flex-col p-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg'}`;
            
            const buyButtonHTML = isPurchased 
                ? `<button class="buy-plan-btn mt-3 bg-gray-400 dark:bg-gray-600 text-white font-bold text-sm py-2 px-5 rounded-lg cursor-not-allowed" disabled>Already Active</button>`
                : `<button data-plan-id="${plan.id}" class="buy-plan-btn mt-3 bg-blue-600 text-white font-bold text-sm py-2 px-5 rounded-lg hover:bg-blue-700">Buy Now</button>`;
            
            const promoOrActiveHTML = isActive 
                ? `<div class="absolute top-2 right-2 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg z-10">ACTIVE</div>`
                : (plan.promoBannerText ? `<div class="promo-banner">${plan.promoBannerText}</div>` : '');

            const claimHTML = isActive ? `
                <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Daily Progress</p>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div id="progress-${plan.planKey}" class="bg-teal-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <button id="claim-${plan.planKey}" data-plan-key="${plan.planKey}" class="claim-btn w-full mt-3 bg-teal-500 text-white font-bold py-2 rounded-lg hover:bg-teal-600 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Claim Reward</button>
                </div>
            ` : '';

            return `<div class="${containerClass}">
                ${promoOrActiveHTML}
                <div class="flex items-center">
                    <img src="${plan.image}" class="w-24 h-24 flex-shrink-0 object-cover rounded-lg" alt="${plan.name}" loading="lazy">
                    <div class="flex-1 ml-4">
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">${plan.name}</h3>
                        <p class="text-gray-700 dark:text-gray-300 text-sm mt-1">Investment: <span class="font-bold text-gray-900 dark:text-white">$${plan.investment}</span> | Profit: <span class="font-bold text-gray-900 dark:text-white">$${plan.totalProfitValue}</span></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2"><i class="ri-time-line text-teal-500 dark:text-teal-400"></i> Duration: <span class="font-bold text-gray-900 dark:text-white">${plan.duration} Days</span></p>
                        <div class="mt-2 text-xs border-t border-gray-200 dark:border-gray-700 pt-2">
                            <p class="text-teal-600 dark:text-teal-400">${plan.dailyProfitRange} <span class="text-gray-600 dark:text-gray-400">Daily Profit</span></p>
                            <p class="text-teal-600 dark:text-teal-400">${plan.totalProfitRange} <span class="text-gray-600 dark:text-gray-400">Total Profit</span></p>
                        </div>
                    </div>
                </div>
                ${showBuyButton ? buyButtonHTML : ''}
                ${claimHTML}
            </div>`;
        }

        async function buyPlan(planId) {
            const plan = appSettings.plans[planId];
            if (!plan) { showAlert("Error", "Plan not found."); return; }

            const userWallet = currentUserData.wallet || { deposited: 0 };
            if (userWallet.deposited < plan.investment) {
                showAlert("Insufficient Funds", `You need at least $${plan.investment.toFixed(2)} in your deposited balance to buy this plan.`);
                return;
            }
            
            const isAlreadyActive = Object.values(currentUserData.activePlans || {}).some(p => p.id === planId);
            if(isAlreadyActive) {
                showAlert("Plan Active", "You have already purchased this plan. It is currently active.");
                return;
            }

            if (!confirm(`Are you sure you want to buy the "${plan.name}" for $${plan.investment}? This amount will be deducted from your deposited balance.`)) return;

            const currentUser = auth.currentUser;
            const newBalance = userWallet.deposited - plan.investment;
            const newActivePlanRef = database.ref(`users/${currentUser.uid}/activePlans`).push();
            
            const planData = { ...plan, id: planId, purchaseDate: new Date().toISOString(), lastClaimDate: new Date().toISOString() };

            const updates = {};
            updates[`/users/${currentUser.uid}/wallet/deposited`] = newBalance;
            updates[`/users/${currentUser.uid}/activePlans/${newActivePlanRef.key}`] = planData;
            
            const transactionRef = database.ref(`users/${currentUser.uid}/transactions/other`).push();
            updates[`/users/${currentUser.uid}/transactions/other/${transactionRef.key}`] = {
                amount: plan.investment,
                type: 'Plan Purchase',
                details: `Purchased ${plan.name}`,
                timestamp: new Date().toISOString(),
                status: 'approved'
            };

            try {
                await database.ref().update(updates);
                showAlert("Success", `You have successfully purchased the "${plan.name}".`);
            } catch (error) {
                showAlert("Error", "There was an error purchasing the plan. " + error.message);
            }
        }
        
        function showAlert(title, message) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-modal').style.display = 'flex';
        }

        function setupSlider() {
            const container = document.getElementById('image-slider-container');
            const slider = document.getElementById('slider-inner');
            const dots = document.getElementById('slider-dots');
            if (!slider || !dots || !container) return;
            slider.innerHTML = ''; dots.innerHTML = '';
            
            const images = appSettings.sliderImages || [];
            if(images.length === 0) {
                container.style.display = 'none'; return;
            } else {
                 container.style.display = 'block';
            }

            images.forEach(slide => {
                const link = document.createElement('a');
                link.href = slide.linkUrl || '#';
                link.className = 'w-full flex-shrink-0';
                if(slide.linkUrl) link.target = '_blank';
                const img = document.createElement('img');
                img.src = slide.imageUrl;
                img.className = "w-full h-48 object-cover";
                img.loading = "lazy";
                link.appendChild(img);
                slider.appendChild(link);
            });
            
            const total = images.length;
            if (total <= 1) return;
            
            let current = 0;
            let autoSlideInterval = null;

            for (let i = 0; i < total; i++) {
                const d = document.createElement('div');
                d.className = `w-2 h-2 rounded-full cursor-pointer transition-colors ${i === 0 ? 'bg-white' : 'bg-gray-500/50'}`;
                d.onclick = () => { current = i; update(); resetAutoSlide(); };
                dots.appendChild(d);
            }

            const update = (animate = true) => {
                slider.style.transition = animate ? 'transform 0.5s ease-in-out' : 'none';
                slider.style.transform = `translateX(-${current * 100}%)`;
                dots.childNodes.forEach((d, i) => d.className = `w-2 h-2 rounded-full cursor-pointer transition-colors ${i === current ? 'bg-white' : 'bg-gray-500/50'}`);
            };

            const startAutoSlide = () => {
                autoSlideInterval = setInterval(() => { current = (current + 1) % total; update(); }, 3000);
            };

            const resetAutoSlide = () => {
                clearInterval(autoSlideInterval);
                startAutoSlide();
            };

            startAutoSlide();

            let startX = 0;
            let moveX = 0;
            let isDragging = false;
            
            const onDragStart = (e) => {
                isDragging = true;
                startX = e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
                clearInterval(autoSlideInterval);
            };

            const onDragMove = (e) => {
                if (!isDragging) return;
                moveX = e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
                const diff = moveX - startX;
                slider.style.transform = `translateX(calc(-${current * 100}% + ${diff}px))`;
                slider.style.transition = 'none';
            };

            const onDragEnd = () => {
                if (!isDragging) return;
                isDragging = false;
                const diff = moveX - startX;
                if (Math.abs(diff) > 50) {
                    current = diff < 0 ? (current + 1) % total : (current - 1 + total) % total;
                }
                update();
                startAutoSlide();
            };
            
            container.addEventListener('mousedown', onDragStart);
            container.addEventListener('touchstart', onDragStart);
            container.addEventListener('mousemove', onDragMove);
            container.addEventListener('touchmove', onDragMove);
            container.addEventListener('mouseup', onDragEnd);
            container.addEventListener('mouseleave', onDragEnd);
            container.addEventListener('touchend', onDragEnd);
        }

        function setupEarningsChart(earningsData) {
            const ctx = document.getElementById('earningsChart'); if (!ctx) return;
            const dailyData = { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], data: [0, 0, 0, 0, 0, 0, 0] };
            if (earningsChart) earningsChart.destroy();
            
            const isDarkMode = document.documentElement.classList.contains('dark');
            const line_color = isDarkMode ? '#2dd4bf' : '#14b8a6';
            const bg_color = isDarkMode ? 'rgba(45,212,191,0.1)' : 'rgba(20, 184, 166, 0.1)';

            earningsChart = new Chart(ctx, { type: 'line', data: { labels: dailyData.labels, datasets: [{ data: dailyData.data, borderColor: line_color, tension: 0.4, fill: true, backgroundColor: bg_color }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { display: false } } } });
        }
        
        // --- EVENT LISTENERS ---
        function setupStaticListeners() {
            const loginModal = document.getElementById('login-modal');
            const signupModal = document.getElementById('signup-modal');
            const forgotPasswordModal = document.getElementById('forgot-password-modal');
            const loginStatus = document.getElementById('login-status');
            const signupStatus = document.getElementById('signup-status');

            document.getElementById('copyright-year').textContent = new Date().getFullYear();

            document.getElementById('login-btn-landing').addEventListener('click', () => { loginModal.style.display = 'flex'; loginStatus.textContent = ''; });
            document.getElementById('footer-login-btn').addEventListener('click', (e) => { e.preventDefault(); loginModal.style.display = 'flex'; loginStatus.textContent = ''; });
            document.getElementById('signup-btn-landing').addEventListener('click', () => { signupModal.style.display = 'flex'; signupStatus.textContent = ''; });
            document.getElementById('get-started-btn').addEventListener('click', () => { signupModal.style.display = 'flex'; signupStatus.textContent = ''; });
            document.getElementById('close-login-modal').addEventListener('click', () => loginModal.style.display = 'none');
            document.getElementById('close-signup-modal').addEventListener('click', () => signupModal.style.display = 'none');
            document.getElementById('close-profile-modal').addEventListener('click', () => document.getElementById('profile-edit-modal').style.display = 'none');
            document.getElementById('forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); loginModal.style.display = 'none'; forgotPasswordModal.style.display = 'flex'; });
            document.getElementById('close-forgot-modal').addEventListener('click', () => forgotPasswordModal.style.display = 'none');
            document.getElementById('alert-close-btn').addEventListener('click', () => document.getElementById('alert-modal').style.display = 'none');

            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                loginStatus.textContent = 'Logging in...';
                loginStatus.className = 'text-yellow-400 text-sm mt-2 text-center';
                const email = e.target.elements['login-email'].value;
                const password = e.target.elements['login-password'].value;
                auth.signInWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        if (!userCredential.user.emailVerified) {
                            loginStatus.innerHTML = `Your email is not verified. Please check your inbox or spam folder.<br><button id="resend-verify-btn" class="text-teal-400 underline mt-2">Resend Verification Email</button>`;
                            document.getElementById('resend-verify-btn').onclick = () => {
                                userCredential.user.sendEmailVerification();
                                loginStatus.textContent = 'A new verification email has been sent.';
                                loginStatus.className = 'text-green-500 text-sm mt-2 text-center';
                                setTimeout(() => auth.signOut(), 2000);
                            };
                        } else {
                            // On successful login, close the modal.
                            // The onAuthStateChanged listener will automatically handle the page transition to the dashboard.
                            loginModal.style.display = 'none';
                            e.target.reset();
                        }
                    })
                    .catch(err => { 
                        loginStatus.textContent = err.message; 
                        loginStatus.className = 'text-red-500 text-sm mt-2 text-center'; 
                    });
            });

            document.getElementById('signup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const p1 = e.target.elements['signup-password'].value;
                const p2 = e.target.elements['signup-confirm-password'].value;
                if (p1 !== p2) { signupStatus.textContent = "Passwords do not match."; signupStatus.className = "text-red-500 text-sm mt-4 text-center"; return; }
                signupStatus.textContent = 'Creating account...'; signupStatus.className = 'text-yellow-400 text-sm mt-4 text-center';
                auth.createUserWithEmailAndPassword(e.target.elements['signup-email'].value, p1)
                    .then(userCredential => {
                        const user = userCredential.user;
                        user.updateProfile({ displayName: e.target.elements['signup-username'].value });
                        user.sendEmailVerification();
                        
                        // Generate a unique referral code for the new user
                        const newReferralCode = generateReferralCode();
                        
                        const newUser = {
                            profile: { 
                                username: e.target.elements['signup-username'].value, 
                                email: user.email, 
                                name: e.target.elements['signup-username'].value, 
                                avatar: `https://i.pravatar.cc/150?u=${user.uid}`,
                                referralCode: newReferralCode
                            },
                            wallet: { deposited: 0, withdrawable: 0 },
                            activePlans: {}, team: {}, transactions: {}
                        };
                        database.ref('users/' + user.uid).set(newUser);
                        auth.signOut();
                        showAlert("Account Created Successfully!", "A verification link has been sent to your email. Please check your inbox (and spam folder) to verify your account before logging in.");
                        signupStatus.textContent = "";
                        signupModal.style.display = 'none';
                        e.target.reset();
                    })
                    .catch(err => { signupStatus.textContent = err.message; signupStatus.className = 'text-red-500 text-sm mt-4 text-center'; });
            });
            
            document.getElementById('main-content-container').addEventListener('click', function(e) {
                const buyButton = e.target.closest('.buy-plan-btn');
                if (buyButton && !buyButton.disabled) {
                    const planId = buyButton.dataset.planId;
                    if (planId) buyPlan(planId);
                }

                const claimButton = e.target.closest('.claim-btn');
                if (claimButton && !claimButton.disabled) {
                    const planKey = claimButton.dataset.planKey;
                    if (planKey) handleClaim(planKey);
                }
            });
        }
        
        function setupDashboardListeners() {
            const sidebar = document.getElementById('sidebar'), 
                  overlay = document.getElementById('sidebar-overlay');

            const open = () => { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('opacity-0','pointer-events-none'); };
            const close = () => { sidebar.classList.add('-translate-x-full'); overlay.classList.add('opacity-0','pointer-events-none'); };

            document.getElementById('open-sidebar').addEventListener('click', open);
            document.getElementById('close-sidebar').addEventListener('click', close);
            overlay.addEventListener('click', close);

            document.body.addEventListener('click', function(e) {
                const link = e.target.closest('.nav-link, .sidebar-link');
                const logoutBtn = e.target.closest('#logout-btn-sidebar, #logout-btn-profile');

                if (logoutBtn) {
                    e.preventDefault();
                    handleLogout();
                } 
                else if (link) {
                    e.preventDefault();
                    const target = link.dataset.target;
                    if (target && target !== 'logout') { 
                        window.location.hash = target; 
                    }
                    if (window.innerWidth < 768) close();
                }
            });

            window.addEventListener('hashchange', handleHashChange);
        }
        
        function updateActiveLink(target) { 
            document.querySelectorAll('.nav-link, .sidebar-link').forEach(l=>{
                l.classList.remove('active-nav'); 
                if(l.dataset.target === target) l.classList.add('active-nav');
            });
        }

        // --- CLAIMING LOGIC ---
        function updateClaimStatus() {
            if (!currentUserData || !currentUserData.activePlans) return;
            const activePlans = currentUserData.activePlans;
            const now = new Date().getTime();
            const TWENTY_FOUR_HOURS_MS = 24 * 60 * 60 * 1000;

            Object.keys(activePlans).forEach(planKey => {
                const plan = activePlans[planKey];
                const progressBar = document.getElementById(`progress-${planKey}`);
                const claimButton = document.getElementById(`claim-${planKey}`);
                
                if (!progressBar || !claimButton) return;
                
                const lastClaimTime = new Date(plan.lastClaimDate || plan.purchaseDate).getTime();
                const timeElapsed = now - lastClaimTime;
                
                let progress = Math.min(100, (timeElapsed / TWENTY_FOUR_HOURS_MS) * 100);

                progressBar.style.width = `${progress}%`;

                if (progress >= 100) {
                    claimButton.disabled = false;
                } else {
                    claimButton.disabled = true;
                }
            });
        }
        
        async function handleClaim(planKey) {
            const plan = currentUserData.activePlans[planKey];
            if (!plan) {
                showAlert("Error", "Could not find the plan to claim.");
                return;
            }

            const lastClaimTime = new Date(plan.lastClaimDate || plan.purchaseDate).getTime();
            if (new Date().getTime() - lastClaimTime < (24 * 60 * 60 * 1000)) {
                showAlert("Not Yet", "You can only claim the reward once every 24 hours.");
                return;
            }

            const dailyProfit = parseFloat(plan.dailyProfitRange.replace('$', ''));
            if (isNaN(dailyProfit)) {
                showAlert("Error", "Could not determine daily profit for this plan.");
                return;
            }

            const currentUser = auth.currentUser;
            const currentWithdrawable = currentUserData.wallet.withdrawable || 0;
            const newWithdrawable = currentWithdrawable + dailyProfit;
            const newTimestamp = new Date().toISOString();

            const updates = {};
            updates[`/users/${currentUser.uid}/activePlans/${planKey}/lastClaimDate`] = newTimestamp;
            updates[`/users/${currentUser.uid}/wallet/withdrawable`] = newWithdrawable;
            const earningRef = database.ref(`users/${currentUser.uid}/transactions/earnings`).push();
            updates[`/users/${currentUser.uid}/transactions/earnings/${earningRef.key}`] = {
                amount: dailyProfit,
                type: 'Earning',
                details: `Daily profit from ${plan.name}`,
                timestamp: newTimestamp,
                status: 'approved'
            };

            try {
                document.getElementById(`claim-${planKey}`).disabled = true;
                await database.ref().update(updates);
                showAlert("Success!", `You have successfully claimed $${dailyProfit.toFixed(2)} from your ${plan.name} plan.`);
            } catch (error) {
                showAlert("Claim Failed", "An error occurred while claiming your reward: " + error.message);
                document.getElementById(`claim-${planKey}`).disabled = false;
            }
        }
    </script>
</body>
</html>
